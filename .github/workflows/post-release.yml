name: Post Release

on:
  release:
    types: published

jobs:
  setup-credentials:
    name: Setup Actor Credentials
    uses: ./.github/workflows/actor-credentials.yml
    with:
      actor: ${{ github.event.release.author.login }}
    permissions:
      contents: write
    secrets: inherit

  merge-into-main:
    name: Merge into main
    needs: setup-credentials
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          ref: main
          token: ${{ secrets[format('PERSONAL_GITHUB_TOKEN_{0}', needs.setup-credentials.outputs.author_uppercase)] }}
          persist-credentials: true
      - name: Configure Git author
        uses: Homebrew/actions/git-user-config@main
        with:
          token: ${{ secrets[format('PERSONAL_GITHUB_TOKEN_{0}', needs.setup-credentials.outputs.author_uppercase)] }}
      - name: Merge release branch
        run: |
          git fetch origin "release/${TAG_NAME}"
          git merge --ff-only "origin/release/${TAG_NAME}"
          git push origin main
          git push origin --delete "release/${TAG_NAME}"
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}

  publish-pod:
    name: Publish Pod
    needs:
      - merge-into-main
      - setup-credentials
    runs-on: macOS-14
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          ref: ${{ github.event.release.tag_name }}
          persist-credentials: false
      - name: Deploy to CocoaPods
        run: make pod_publish
        env:
          DEVELOPER_DIR: /Applications/Xcode_15.0.1.app
          COCOAPODS_TRUNK_TOKEN: ${{ secrets[format('COCOAPODS_TRUNK_TOKEN_{0}', needs.setup-credentials.outputs.author_uppercase)] }}

  dispatch-plugins:
    name: Dispatch Plugins Repository
    needs: merge-into-main
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          ref: ${{ github.event.release.tag_name }}
          persist-credentials: false
      - name: Parse checksum
        id: parse_checksum
        run: echo "checksum=$(grep -o '[a-fA-F0-9]\{64\}' Package.swift)" >> "$GITHUB_OUTPUT"
      - name: Dispatch release of plugins package
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
        with:
          token: ${{ secrets.SIMPLYDANNY_PLUGINS_SYNC }}
          repository: SimplyDanny/SwiftLintPlugins
          event-type: swiftlint-release
          client-payload: |-
            {
              "title": "${{ github.event.release.name }}",
              "tag": "${{ github.event.release.tag_name }}",
              "checksum": "${{ steps.parse_checksum.outputs.checksum }}"
            }

  bump-homebrew:
    name: Bump Homebrew Formula
    needs:
      - merge-into-main
      - setup-credentials
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/homebrew/ubuntu24.04:latest
    permissions: {}
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          test-bot: false
      - name: Configure Git author
        uses: Homebrew/actions/git-user-config@main
        with:
          token: ${{ secrets[format('PERSONAL_GITHUB_TOKEN_{0}', needs.setup-credentials.outputs.author_uppercase)] }}
      - name: Update Homebrew formula
        uses: Homebrew/actions/bump-packages@main
        with:
          token: ${{ secrets[format('PERSONAL_GITHUB_TOKEN_{0}', needs.setup-credentials.outputs.author_uppercase)] }}
          formulae: swiftlint

  build-docker:
    name: Build Docker Images
    needs: merge-into-main
    uses: ./.github/workflows/docker.yml
    permissions:
      contents: read
      packages: write
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    with:
      tag: ${{ github.event.release.tag_name }}
