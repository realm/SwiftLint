trigger:
- main

jobs:
- job: Sourcery
  pool:
    vmImage: 'macOS-12'
  steps:
    - script: brew install sourcery
      displayName: Install Sourcery
    - script: make --always-make sourcery
      displayName: Generate sources
    - script: "! git diff -U0 | grep '^[-+][^-+]' | grep --invert-match '// Generated using Sourcery'"
      displayName: Check changed files ignoring Sourcery's version

- job: Linux
  pool:
    vmImage: 'ubuntu-latest'
  strategy:
    maxParallel: 10
    matrix:
      swift57:
        containerImage: swift:5.7
  container: $[ variables['containerImage'] ]
  steps:
    - script: swift test --parallel -Xswiftc -DDISABLE_FOCUSED_EXAMPLES
      displayName: swift test

# TODO: Re-enable when FB11648454 is fixed
# - job: Xcode
#   pool:
#     vmImage: 'macOS-12'
#   strategy:
#     maxParallel: 10
#     matrix:
#       xcode14:
#         DEVELOPER_DIR: /Applications/Xcode_14.0.1.app
#   steps:
#     - script: |
#         sw_vers
#         xcodebuild -version
#       displayName: Version Informations
#     - script: xcodebuild -scheme swiftlint test -destination "platform=macOS" OTHER_SWIFT_FLAGS="\$(inherited) -D DISABLE_FOCUSED_EXAMPLES"
#       displayName: xcodebuild test

- job: SwiftPM
  pool:
    vmImage: 'macOS-12'
  strategy:
    maxParallel: 10
    matrix:
      xcode14:
        DEVELOPER_DIR: /Applications/Xcode_14.0.1.app
  steps:
    - script: |
        sw_vers
        xcodebuild -version
      displayName: Version Informations
    - script: swift test --parallel --enable-code-coverage -Xswiftc -DDISABLE_FOCUSED_EXAMPLES
      displayName: swift test
    # - script: |
    #     xcrun llvm-cov export -format="lcov" .build/debug/SwiftLintPackageTests.xctest/Contents/MacOS/SwiftLintPackageTests -instr-profile .build/debug/codecov/default.profdata > coverage.lcov
    #     bash <(curl -s https://codecov.io/bash)
    #   displayName: Upload code coverage
    #   condition: eq(variables['DEVELOPER_DIR'], '/Applications/Xcode_14.0.1.app')

- job: CocoaPods
  pool:
    vmImage: 'macOS-12'
  variables:
    DEVELOPER_DIR: /Applications/Xcode_13.4.1.app
  steps:
    - script: bundle install --path vendor/bundle
      displayName: bundle install
    - script: bundle exec pod repo update
      displayName: pod repo update
    - script: bundle exec pod lib lint --verbose
      displayName: pod lib lint
